# my global config
global:
  scrape_interval: 15s # By default, scrape targets every 15 seconds.
  evaluation_interval: 15s # By default, scrape targets every 15 seconds.

rule_files:
  - "alerts.yml"

alerting:
  alertmanagers:
    - scheme: http
      static_configs:
        - targets: ["alertmanager:9093"]

scrape_configs:
  - job_name: docker-cadvisor
    static_configs:
      - targets: ["10.1.0.203:8280"]
        labels:
          env: monitoring
      - targets: ["10.1.0.201:8280"]
        labels:
          env: org
      - targets: ["10.1.0.200:8280"]
        labels:
          env: net

  - job_name: docker-node-exporter
    static_configs:
      - targets: ["10.1.0.203:8281"]
        labels:
          env: monitoring
      - targets: ["10.1.0.201:8281"]
        labels:
          env: org
      - targets: ["10.1.0.200:8281"]
        labels:
          env: net

  # TODO: use Docker Service Discovery https://prometheus.io/docs/prometheus/latest/configuration/configuration/#docker_sd_config
  - job_name: docker-containers
    sample_limit: 50000
    static_configs:
      - targets: ["prometheus:9090"]
        labels:
          app: prometheus
      - targets: ["grafana:3000"]
        labels:
          app: grafana
      - targets: ["alertmanager:9093"]
        labels:
          app: alertmanager
      - targets: ["elasticsearch_exporter:9114"]
        labels:
          app: elasticsearch_exporter
          env: org
      - targets: ["blackbox_exporter:9115"]
        labels:
          app: blackbox_exporter
          env: org

  - job_name: docker-nginx
    static_configs:
      - targets: ["10.1.0.200:9113"]
        labels:
          app: off
          service: frontend
          env: net

  - job_name: docker-apache
    static_configs:
      - targets: ["10.1.0.200:9117"]
        labels:
          app: off
          service: backend
          env: net

  - job_name: docker-statsd
    static_configs:
      - targets: ["10.1.0.200:9102"]
        labels:
          app: robotoff
          service: api
          env: net
      - targets: ["10.1.0.201:9102"]
        labels:
          app: robotoff
          service: api
          env: org

  - job_name: docker-postgres
    static_configs:
      - targets: ["10.1.0.201:9187"]
        labels:
          app: robotoff
          service: postgres
          env: org
      - targets: ["10.1.0.200:9187"]
        labels:
          app: robotoff
          service: postgres
          env: net

  #--------#
  # PROBES #
  #--------#
  - job_name: blackbox-exporter
    metrics_path: /probe
    scrape_interval: 60s
    params:
      module: [http_probe]
    relabel_configs:
      - source_labels: [__address__]
        regex: ^([^|]+)\|(.+)$ # splits target by | and uses 2nd token as target for blackbox_exporter
        replacement: ${2}
        target_label: __param_target
      - source_labels: [__address__]
        regex: (.+)\|(.+) # splits target by | and uses 1st token as 'app' label
        replacement: ${1}
        target_label: app
      - source_labels: [__param_target]
        target_label: instance
      - replacement: blackbox_exporter:9115
        target_label: __address__
    static_configs:
      - targets:
          - off|https://world.openfoodfacts.net
          - off-web|https://world.openfoodfacts.net/images/products/376/002/924/8001/1.100.jpg
          - off-product|https://world.openfoodfacts.net/product/3017620422003/nutella-ferrero
          - robotoff|https://robotoff.openfoodfacts.net/api/v1/health
          - off-query|https://query.openfoodfacts.net/health
          - off-search|https://search.openfoodfacts.net/
        labels:
          env: net
      - targets:
          # Open Food Facts app (apache)
          - off|https://world.openfoodfacts.org
          # Product page
          - off-product|https://world.openfoodfacts.org/product/3017620422003/nutella-ferrero
          # Open Food Facts static resources
          - off-static|https://static.openfoodfacts.org/images/logos/off-logo-horizontal-light.svg
          # Open Food Facts images
          - off-images|https://images.openfoodfacts.org/images/products/376/002/924/8001/1.100.jpg
          - obf|https://world.openbeautyfacts.org
          - opff|https://world.openpetfoodfacts.org
          - opf|https://world.openproductsfacts.org
          - off-pro|https://world.pro.openfoodfacts.org
          - robotoff|https://robotoff.openfoodfacts.org/api/v1/health
          - off-query|https://query.openfoodfacts.org/health
          - off-search|https://search.openfoodfacts.org/
          - grafana|https://grafana.openfoodfacts.org/api/health
          - prometheus|https://prometheus.openfoodfacts.org/-/healthy
          - alertmanager|https://alertmanager.openfoodfacts.org/-/healthy
          - kibana|https://kibana.openfoodfacts.org/status
          - elasticsearch|http://10.1.0.203:9200/_cluster/health?wait_for_status=yellow&timeout=50s
        labels:
          env: org
  - job_name: blackbox-exporter-icmp
    metrics_path: /probe
    scrape_interval: 60s
    params:
      module: [icmp_probe]
    relabel_configs:
      - source_labels: [__address__]
        regex: ^([^|]+)\|(.+)$ # splits target by | and uses 2nd token as target for blackbox_exporter
        replacement: ${2}
        target_label: __param_target
      - source_labels: [__address__]
        regex: (.+)\|(.+) # splits target by | and uses 1st token as 'app' label
        replacement: ${1}
        target_label: app
      - source_labels: [__param_target]
        target_label: instance
      - replacement: blackbox_exporter:9115
        target_label: __address__
    static_configs:
      - targets:
          - ovh1:ovh1.openfoodfacts.org
          - proxy1_ovh:proxy1.openfoodfacts.org
          - proxy2_free:proxy2.openfoodfacts.org
          - ovh2:ovh2.openfoodfacts.org
          - ovh3:ovh3.openfoodfacts.org
          - off1:off1.openfoodfacts.org
          - off2:off2.openfoodfacts.org
